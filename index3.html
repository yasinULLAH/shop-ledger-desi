<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Management App - Yasin Ullah</title>
    <meta name="description" content="Manage and track customer receipts, ledger, reports, and reminders with offline support.">
    <meta name="keywords" content="receipt management, ledger, reports, reminders, offline app, IndexedDB, Yasin Ullah, Pakistan">
    <meta name="author" content="Yasin Ullah">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: #eee;
            margin-right: 5px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .tab-button.active {
            background-color: #fff;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        form input, form select, form textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        form button {
            background-color: #5cb85c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        form button:hover {
            background-color: #4cae4c;
        }
        .receipt-list, .search-results, .ledger-details, .report-details, .reminder-list {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .actions button {
            padding: 5px 10px;
            margin-right: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .actions .edit {
            background-color: #f0ad4e;
            color: white;
        }
        .actions .delete {
            background-color: #d9534f;
            color: white;
        }
        .actions .print {
            background-color: #0275d8;
            color: white;
        }
        .actions .send-reminder {
            background-color: #5bc0de;
            color: white;
        }
        .receipt-preview {
            border: 1px dashed #ccc;
            padding: 20px;
            margin-top: 20px;
            background-color: #fff;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .receipt-header, .receipt-footer {
            text-align: center;
            margin-bottom: 10px;
        }
        .receipt-line {
            border-bottom: 1px dashed #ccc;
            margin: 5px 0;
        }
        .export-import {
            margin-top: 20px;
            text-align: center;
        }
        .export-import button, .export-import input[type="file"] {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #0275d8;
            color: white;
        }
        .export-import input[type="file"] {
             display: none;
        }
         .export-import label {
            background-color: #0275d8;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
         }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                margin-right: 0;
                margin-bottom: 5px;
            }
            form input, form select, form textarea {
                width: calc(100% - 20px);
            }
        }

        /* Receipt Layout Styling */
        .receipt-layout {
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid #000;
            padding: 15px;
            margin-top: 20px;
            background-color: #fff;
        }
        .receipt-layout .header, .receipt-layout .footer {
            text-align: center;
            margin-bottom: 15px;
        }
        .receipt-layout .header h3 {
            margin: 0;
            font-size: 18px;
        }
        .receipt-layout .header p {
            margin: 2px 0;
            font-size: 12px;
        }
        .receipt-layout .info-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .receipt-layout .info-line span {
            flex: 1;
        }
        .receipt-layout .info-line span:last-child {
            text-align: right;
        }
        .receipt-layout .divider {
            border-bottom: 1px dashed #000;
            margin: 10px 0;
        }
        .receipt-layout .item-details {
            margin-bottom: 10px;
        }
        .receipt-layout .item-details p {
            margin: 2px 0;
        }
        .receipt-layout .total-line {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-weight: bold;
        }
        .receipt-layout .signature-line {
            margin-top: 20px;
            text-align: right;
        }
        .receipt-layout .signature-line span {
            border-top: 1px solid #000;
            padding-top: 5px;
            margin-right: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Receipt Management App</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'receipts')">Receipts</button>
            <button class="tab-button" onclick="openTab(event, 'search')">Search</button>
            <button class="tab-button" onclick="openTab(event, 'ledger')">Ledger</button>
            <button class="tab-button" onclick="openTab(event, 'reports')">Reports</button>
            <button class="tab-button" onclick="openTab(event, 'reminders')">Reminders</button>
            <button class="tab-button" onclick="openTab(event, 'admin')">Admin Settings</button>
        </div>

        <div id="receipts" class="tab-content active">
            <h2>Receipts</h2>
            <form id="receipt-form">
                <input type="hidden" id="receipt-id">
                <label for="receipt-date">Date:</label>
                <input type="date" id="receipt-date" required>

                <label for="customer-name">Customer Name:</label>
                <input type="text" id="customer-name" required>

                <label for="customer-mobile">Mobile:</label>
                <input type="text" id="customer-mobile">

                <label for="item-model">Item/Model:</label>
                <input type="text" id="item-model" required>

                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" value="1" min="1" required>

                <label for="installment-months">Installment Months:</label>
                <input type="number" id="installment-months" value="1" min="1">

                <label for="total-price">Total Price:</label>
                <input type="number" id="total-price" step="0.01" required>

                <label for="status">Status:</label>
                <select id="status" required>
                    <option value="Paid">Paid</option>
                    <option value="Udhar">Udhar</option>
                </select>

                <label for="approval">Approval:</label>
                <input type="text" id="approval">

                <button type="submit">Save Receipt</button>
            </form>

            <div class="receipt-list">
                <h3>All Receipts</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer Name</th>
                            <th>Mobile</th>
                            <th>Item/Model</th>
                            <th>Qty</th>
                            <th>Months</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Approval</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="receipts-table-body">
                        <!-- Receipts will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="search" class="tab-content">
            <h2>Search Receipts</h2>
            <form id="search-form">
                <label for="search-term">Search Term:</label>
                <input type="text" id="search-term" placeholder="Enter keyword to search">
                <button type="submit">Search</button>
            </form>
            <div class="search-results">
                <h3>Search Results</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer Name</th>
                            <th>Mobile</th>
                            <th>Item/Model</th>
                            <th>Qty</th>
                            <th>Months</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Approval</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="search-results-table-body">
                        <!-- Search results will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="ledger" class="tab-content">
            <h2>Customer Ledger</h2>
            <form id="ledger-form">
                <label for="ledger-customer-name">Customer Name:</label>
                <input type="text" id="ledger-customer-name" list="customer-names-list">
                 <datalist id="customer-names-list"></datalist>
                <button type="submit">View Ledger</button>
            </form>
            <div class="ledger-details">
                <h3>Ledger Details for <span id="ledger-customer-display"></span></h3>
                 <p>Total Udhar: <span id="total-udhar">0</span></p>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Item/Model</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Running Udhar</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-table-body">
                        <!-- Ledger details will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <h2>Reports</h2>
            <form id="report-form">
                 <label for="report-type">Report Type:</label>
                 <select id="report-type">
                     <option value="daily">Daily Sales</option>
                     <option value="monthly">Monthly Sales</option>
                     <option value="total-paid">Total Paid</option>
                     <option value="total-udhar">Total Udhar</option>
                 </select>

                 <label for="report-date" id="report-date-label">Date:</label>
                 <input type="date" id="report-date">

                 <label for="report-month" id="report-month-label" style="display: none;">Month:</label>
                 <input type="month" id="report-month" style="display: none;">

                 <button type="submit">Generate Report</button>
            </form>
            <div class="report-details">
                <h3>Report Results</h3>
                <div id="report-output">
                    <!-- Report results will be displayed here -->
                </div>
            </div>
        </div>

        <div id="reminders" class="tab-content">
            <h2>Reminders</h2>
             <p>Note: This feature provides a list of customers with 'Udhar' status. You'll need to manually send SMS/WhatsApp reminders using the provided contact information.</p>
            <div class="reminder-list">
                <h3>Customers with Udhar Status</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Mobile</th>
                            <th>Total Udhar</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reminders-table-body">
                        <!-- Reminders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="admin" class="tab-content">
            <h2>Admin Settings</h2>
            <form id="admin-settings-form">
                <label for="business-name">Business Name:</label>
                <input type="text" id="business-name">

                <label for="business-contact">Contact:</label>
                <input type="text" id="business-contact">

                <label for="business-email">Email:</label>
                <input type="email" id="business-email">

                <label for="business-address">Address:</label>
                <textarea id="business-address"></textarea>

                <label for="business-logo">Logo URL (Optional):</label>
                <input type="text" id="business-logo" placeholder="Enter URL of your logo image">

                <button type="submit">Save Settings</button>
            </form>

            <div class="export-import">
                <h3>Backup and Restore</h3>
                <button onclick="exportData()">Export Data (JSON)</button>
                <label for="import-file">Import Data (JSON)</label>
                <input type="file" id="import-file" accept=".json" onchange="importData(event)">
            </div>
        </div>

        <div id="receipt-preview-area" class="receipt-preview" style="display: none;">
            <!-- Receipt preview will be shown here for printing -->
        </div>

    </div>

    <script>
        const dbName = 'ReceiptDB';
        const dbVersion = 1;
        let db;

        // Open or create the IndexedDB database
        const request = indexedDB.open(dbName, dbVersion);

        request.onerror = function(event) {
            console.error('IndexedDB error:', event.target.errorCode);
            alert('Error opening database. Please try again.');
        };

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            // Create object stores if they don't exist
            if (!db.objectStoreNames.contains('receipts')) {
                const receiptStore = db.createObjectStore('receipts', { keyPath: 'id', autoIncrement: true });
                receiptStore.createIndex('date', 'date', { unique: false });
                receiptStore.createIndex('customerName', 'customerName', { unique: false });
                receiptStore.createIndex('status', 'status', { unique: false });
                receiptStore.createIndex('itemModel', 'itemModel', { unique: false });
            }
            if (!db.objectStoreNames.contains('settings')) {
                const settingsStore = db.createObjectStore('settings', { keyPath: 'key' });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            console.log('Database opened successfully');
            loadSettings(); // Load settings when DB is ready
            loadReceipts(); // Load receipts when DB is ready
            loadReminders(); // Load reminders when DB is ready
             populateCustomerNamesForLedger(); // Populate customer names for ledger search
        };

        // --- Tab Navigation ---
        function openTab(event, tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            // Load data specific to the tab
            if (tabName === 'receipts') {
                loadReceipts();
            } else if (tabName === 'reminders') {
                loadReminders();
            } else if (tabName === 'ledger') {
                 populateCustomerNamesForLedger();
            }
        }

        // --- Receipts Tab ---
        const receiptForm = document.getElementById('receipt-form');
        const receiptsTableBody = document.getElementById('receipts-table-body');

        receiptForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const id = document.getElementById('receipt-id').value;
            const date = document.getElementById('receipt-date').value;
            const customerName = document.getElementById('customer-name').value;
            const customerMobile = document.getElementById('customer-mobile').value;
            const itemModel = document.getElementById('item-model').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const installmentMonths = parseInt(document.getElementById('installment-months').value);
            const totalPrice = parseFloat(document.getElementById('total-price').value);
            const status = document.getElementById('status').value;
            const approval = document.getElementById('approval').value;

            const receipt = {
                date: date,
                customerName: customerName,
                customerMobile: customerMobile,
                itemModel: itemModel,
                quantity: quantity,
                installmentMonths: installmentMonths,
                totalPrice: totalPrice,
                status: status,
                approval: approval
            };

            const transaction = db.transaction(['receipts'], 'readwrite');
            const store = transaction.objectStore('receipts');

            if (id) {
                receipt.id = parseInt(id);
                store.put(receipt);
            } else {
                store.add(receipt);
            }

            transaction.oncomplete = function() {
                console.log('Receipt saved successfully');
                receiptForm.reset();
                document.getElementById('receipt-id').value = ''; // Clear hidden ID
                loadReceipts(); // Reload the list
                loadReminders(); // Reload reminders as status might change
                 populateCustomerNamesForLedger(); // Update customer list
            };

            transaction.onerror = function(event) {
                console.error('Error saving receipt:', event.target.error);
                alert('Error saving receipt. Please try again.');
            };
        });

        function loadReceipts() {
            const transaction = db.transaction(['receipts'], 'readonly');
            const store = transaction.objectStore('receipts');
            const request = store.getAll();

            request.onsuccess = function(event) {
                const receipts = event.target.result;
                receiptsTableBody.innerHTML = ''; // Clear current list

                // Sample data (only add if the store is empty)
                if (receipts.length === 0) {
                    const sampleReceipts = [
                        { date: '2023-10-26', customerName: 'Ali Khan', customerMobile: '03001234567', itemModel: 'Bike XYZ', quantity: 1, installmentMonths: 6, totalPrice: 50000, status: 'Udhar', approval: 'Approved' },
                        { date: '2023-10-25', customerName: 'Fatima Ahmed', customerMobile: '03219876543', itemModel: 'Mobile ABC', quantity: 1, installmentMonths: 3, totalPrice: 15000, status: 'Paid', approval: 'Approved' },
                        { date: '2023-10-24', customerName: 'Usman Tariq', customerMobile: '03331122334', itemModel: 'Laptop DEF', quantity: 1, installmentMonths: 12, totalPrice: 80000, status: 'Udhar', approval: 'Pending' },
                        { date: '2023-10-23', customerName: 'Aisha Bibi', customerMobile: '03455566778', itemModel: 'TV GHI', quantity: 1, installmentMonths: 0, totalPrice: 30000, status: 'Paid', approval: 'Approved' }
                    ];
                    const addTransaction = db.transaction(['receipts'], 'readwrite');
                    const addStore = addTransaction.objectStore('receipts');
                    sampleReceipts.forEach(receipt => addStore.add(receipt));
                    addTransaction.oncomplete = function() {
                        console.log('Sample data added');
                        loadReceipts(); // Reload after adding sample data
                    };
                    return; // Stop here to wait for sample data load
                }


                receipts.forEach(receipt => {
                    const row = receiptsTableBody.insertRow();
                    row.insertCell(0).textContent = receipt.date;
                    row.insertCell(1).textContent = receipt.customerName;
                    row.insertCell(2).textContent = receipt.customerMobile;
                    row.insertCell(3).textContent = receipt.itemModel;
                    row.insertCell(4).textContent = receipt.quantity;
                    row.insertCell(5).textContent = receipt.installmentMonths;
                    row.insertCell(6).textContent = receipt.totalPrice.toFixed(2);
                    row.insertCell(7).textContent = receipt.status;
                    row.insertCell(8).textContent = receipt.approval;

                    const actionsCell = row.insertCell(9);
                    actionsCell.classList.add('actions');

                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('edit');
                    editButton.onclick = () => editReceipt(receipt);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete');
                    deleteButton.onclick = () => deleteReceipt(receipt.id);
                    actionsCell.appendChild(deleteButton);

                     const printButton = document.createElement('button');
                    printButton.textContent = 'Print';
                    printButton.classList.add('print');
                    printButton.onclick = () => printReceipt(receipt);
                    actionsCell.appendChild(printButton);
                });
            };

            request.onerror = function(event) {
                console.error('Error loading receipts:', event.target.error);
            };
        }

        function editReceipt(receipt) {
            document.getElementById('receipt-id').value = receipt.id;
            document.getElementById('receipt-date').value = receipt.date;
            document.getElementById('customer-name').value = receipt.customerName;
            document.getElementById('customer-mobile').value = receipt.customerMobile;
            document.getElementById('item-model').value = receipt.itemModel;
            document.getElementById('quantity').value = receipt.quantity;
            document.getElementById('installment-months').value = receipt.installmentMonths;
            document.getElementById('total-price').value = receipt.totalPrice;
            document.getElementById('status').value = receipt.status;
            document.getElementById('approval').value = receipt.approval;

            // Scroll to the form
            receiptForm.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteReceipt(id) {
            if (confirm('Are you sure you want to delete this receipt?')) {
                const transaction = db.transaction(['receipts'], 'readwrite');
                const store = transaction.objectStore('receipts');
                const request = store.delete(id);

                request.onsuccess = function() {
                    console.log('Receipt deleted successfully');
                    loadReceipts(); // Reload the list
                    loadReminders(); // Reload reminders
                     populateCustomerNamesForLedger(); // Update customer list
                };

                request.onerror = function(event) {
                    console.error('Error deleting receipt:', event.target.error);
                    alert('Error deleting receipt. Please try again.');
                };
            }
        }

        async function printReceipt(receipt) {
            const settings = await getSettings();
            const previewArea = document.getElementById('receipt-preview-area');
            previewArea.style.display = 'block';
            previewArea.innerHTML = generateReceiptHTML(receipt, settings);

            // Use a small delay to ensure the content is rendered before printing
            setTimeout(() => {
                 const printWindow = window.open('', '_blank');
                 printWindow.document.write('<html><head><title>Print Receipt</title>');
                 printWindow.document.write('<style>');
                 printWindow.document.write('@page { size: auto; margin: 0mm; }'); // Optional: control print size/margins
                 printWindow.document.write('body { font-family: \'Courier New\', Courier, monospace; font-size: 12px; margin: 10mm; }');
                 printWindow.document.write('.receipt-layout { border: none; padding: 0; margin: 0; }'); // Remove border/padding for print
                 printWindow.document.write('.header, .footer { text-align: center; margin-bottom: 10px; }');
                 printWindow.document.write('.header h3 { margin: 0; font-size: 16px; }');
                 printWindow.document.write('.header p { margin: 1px 0; font-size: 10px; }');
                 printWindow.document.write('.info-line { display: flex; justify-content: space-between; margin-bottom: 3px; }');
                 printWindow.document.write('.info-line span { flex: 1; }');
                 printWindow.document.write('.info-line span:last-child { text-align: right; }');
                 printWindow.document.write('.divider { border-bottom: 1px dashed #000; margin: 5px 0; }');
                 printWindow.document.write('.item-details { margin-bottom: 5px; }');
                 printWindow.document.write('.item-details p { margin: 1px 0; }');
                 printWindow.document.write('.total-line { display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; }');
                 printWindow.document.write('.signature-line { margin-top: 15px; text-align: right; }');
                 printWindow.document.write('.signature-line span { border-top: 1px solid #000; padding-top: 3px; margin-right: 30px; font-size: 10px;}');


                 printWindow.document.write('</style>');
                 printWindow.document.write('</head><body>');
                 printWindow.document.write(previewArea.innerHTML);
                 printWindow.document.write('</body></html>');
                 printWindow.document.close();
                 printWindow.print();

                 previewArea.style.display = 'none'; // Hide preview after printing
            }, 100); // Small delay
        }

        function generateReceiptHTML(receipt, settings) {
            const businessName = settings['business-name'] || 'Your Business Name';
            const businessContact = settings['business-contact'] || 'Contact Info';
            const businessEmail = settings['business-email'] || 'Email';
            const businessAddress = (settings['business-address'] || 'Address').replace(/\n/g, '<br>');
            const businessLogo = settings['business-logo'];

            let logoHtml = '';
            if (businessLogo) {
                logoHtml = `<img src="${businessLogo}" alt="Business Logo" style="max-width: 100px; margin-bottom: 10px;">`;
            }

            const receiptNumber = receipt.id || 'N/A'; // Use ID as receipt number

            return `
                <div class="receipt-layout">
                    <div class="header">
                        ${logoHtml}
                        <h3>${businessName}</h3>
                        <p>${businessAddress}</p>
                        <p>${businessContact} | ${businessEmail}</p>
                    </div>
                    <div class="divider"></div>
                    <div class="info-line">
                        <span>Date: ${receipt.date}</span>
                        <span>Receipt No: ${receiptNumber}</span>
                    </div>
                     <div class="info-line">
                        <span>Customer Name: ${receipt.customerName}</span>
                        <span>Mobile: ${receipt.customerMobile || 'N/A'}</span>
                    </div>
                    <div class="divider"></div>
                    <div class="item-details">
                        <p>Item/Model: ${receipt.itemModel}</p>
                        <p>Quantity: ${receipt.quantity}</p>
                        <p>Installment Months: ${receipt.installmentMonths}</p>
                    </div>
                     <div class="divider"></div>
                    <div class="total-line">
                        <span>Total Price:</span>
                        <span>${receipt.totalPrice.toFixed(2)}</span>
                    </div>
                    <div class="info-line">
                        <span>Status: ${receipt.status}</span>
                        <span>Approval: ${receipt.approval || 'N/A'}</span>
                    </div>
                    <div class="divider"></div>
                    <div class="signature-line">
                        <span>Customer Signature</span>
                    </div>
                     <div class="footer">
                        <p>Thank you for your business!</p>
                    </div>
                </div>
            `;
        }


        // --- Search Tab ---
        const searchForm = document.getElementById('search-form');
        const searchResultsTableBody = document.getElementById('search-results-table-body');

        searchForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const searchTerm = document.getElementById('search-term').value.toLowerCase();
            searchReceipts(searchTerm);
        });

        function searchReceipts(searchTerm) {
             const transaction = db.transaction(['receipts'], 'readonly');
             const store = transaction.objectStore('receipts');
             const request = store.openCursor();

             searchResultsTableBody.innerHTML = ''; // Clear previous results

             request.onsuccess = function(event) {
                 const cursor = event.target.result;
                 if (cursor) {
                     const receipt = cursor.value;
                     // Simple text search across relevant fields
                     if (
                         receipt.date.toLowerCase().includes(searchTerm) ||
                         receipt.customerName.toLowerCase().includes(searchTerm) ||
                         (receipt.customerMobile && receipt.customerMobile.toLowerCase().includes(searchTerm)) ||
                         receipt.itemModel.toLowerCase().includes(searchTerm) ||
                         receipt.status.toLowerCase().includes(searchTerm) ||
                         (receipt.approval && receipt.approval.toLowerCase().includes(searchTerm)) ||
                         receipt.totalPrice.toString().includes(searchTerm) // Search by price
                     ) {
                         const row = searchResultsTableBody.insertRow();
                         row.insertCell(0).textContent = receipt.date;
                         row.insertCell(1).textContent = receipt.customerName;
                         row.insertCell(2).textContent = receipt.customerMobile;
                         row.insertCell(3).textContent = receipt.itemModel;
                         row.insertCell(4).textContent = receipt.quantity;
                         row.insertCell(5).textContent = receipt.installmentMonths;
                         row.insertCell(6).textContent = receipt.totalPrice.toFixed(2);
                         row.insertCell(7).textContent = receipt.status;
                         row.insertCell(8).textContent = receipt.approval;

                         const actionsCell = row.insertCell(9);
                         actionsCell.classList.add('actions');

                         const editButton = document.createElement('button');
                         editButton.textContent = 'Edit';
                         editButton.classList.add('edit');
                         editButton.onclick = () => {
                             editReceipt(receipt);
                             openTab(null, 'receipts'); // Switch to receipts tab for editing
                         };
                         actionsCell.appendChild(editButton);

                         const deleteButton = document.createElement('button');
                         deleteButton.textContent = 'Delete';
                         deleteButton.classList.add('delete');
                         deleteButton.onclick = () => deleteReceipt(receipt.id);
                         actionsCell.appendChild(deleteButton);

                          const printButton = document.createElement('button');
                         printButton.textContent = 'Print';
                         printButton.classList.add('print');
                         printButton.onclick = () => printReceipt(receipt);
                         actionsCell.appendChild(printButton);
                     }
                     cursor.continue();
                 }
             };

             request.onerror = function(event) {
                 console.error('Error searching receipts:', event.target.error);
             };
         }


        // --- Ledger Tab ---
        const ledgerForm = document.getElementById('ledger-form');
        const ledgerTableBody = document.getElementById('ledger-table-body');
        const ledgerCustomerDisplay = document.getElementById('ledger-customer-display');
        const totalUdharDisplay = document.getElementById('total-udhar');

        ledgerForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const customerName = document.getElementById('ledger-customer-name').value;
            viewLedger(customerName);
        });

        function populateCustomerNamesForLedger() {
             const transaction = db.transaction(['receipts'], 'readonly');
             const store = transaction.objectStore('receipts');
             const request = store.getAll();

             request.onsuccess = function(event) {
                 const receipts = event.target.result;
                 const customerNames = [...new Set(receipts.map(r => r.customerName))]; // Get unique names
                 const datalist = document.getElementById('customer-names-list');
                 datalist.innerHTML = ''; // Clear previous options
                 customerNames.forEach(name => {
                     const option = document.createElement('option');
                     option.value = name;
                     datalist.appendChild(option);
                 });
             };

              request.onerror = function(event) {
                 console.error('Error populating customer names:', event.target.error);
             };
        }


        function viewLedger(customerName) {
            const transaction = db.transaction(['receipts'], 'readonly');
            const store = transaction.objectStore('receipts');
            const customerIndex = store.index('customerName');
            const request = customerIndex.openCursor(IDBKeyRange.only(customerName));

            ledgerTableBody.innerHTML = ''; // Clear previous ledger
            ledgerCustomerDisplay.textContent = customerName;
            let runningUdhar = 0;

            request.onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor) {
                    const receipt = cursor.value;

                    if (receipt.status === 'Udhar') {
                        runningUdhar += receipt.totalPrice;
                    }

                    const row = ledgerTableBody.insertRow();
                    row.insertCell(0).textContent = receipt.date;
                    row.insertCell(1).textContent = receipt.itemModel;
                    row.insertCell(2).textContent = receipt.totalPrice.toFixed(2);
                    row.insertCell(3).textContent = receipt.status;
                    row.insertCell(4).textContent = runningUdhar.toFixed(2); // Display running udhar

                    cursor.continue();
                } else {
                    totalUdharDisplay.textContent = runningUdhar.toFixed(2);
                }
            };

            request.onerror = function(event) {
                console.error('Error viewing ledger:', event.target.error);
            };
        }

        // --- Reports Tab ---
        const reportForm = document.getElementById('report-form');
        const reportOutput = document.getElementById('report-output');
        const reportDateLabel = document.getElementById('report-date-label');
        const reportDateInput = document.getElementById('report-date');
        const reportMonthLabel = document.getElementById('report-month-label');
        const reportMonthInput = document.getElementById('report-month');
        const reportTypeSelect = document.getElementById('report-type');

        reportTypeSelect.addEventListener('change', function() {
            const type = reportTypeSelect.value;
            if (type === 'daily') {
                reportDateLabel.style.display = 'block';
                reportDateInput.style.display = 'block';
                reportMonthLabel.style.display = 'none';
                reportMonthInput.style.display = 'none';
            } else if (type === 'monthly') {
                reportDateLabel.style.display = 'none';
                reportDateInput.style.display = 'none';
                reportMonthLabel.style.display = 'block';
                reportMonthInput.style.display = 'block';
            } else {
                 reportDateLabel.style.display = 'none';
                 reportDateInput.style.display = 'none';
                 reportMonthLabel.style.display = 'none';
                 reportMonthInput.style.display = 'none';
            }
        });

        reportForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const reportType = document.getElementById('report-type').value;
            generateReport(reportType);
        });

        function generateReport(type) {
            const transaction = db.transaction(['receipts'], 'readonly');
            const store = transaction.objectStore('receipts');
            const request = store.getAll();

            request.onsuccess = function(event) {
                const receipts = event.target.result;
                let outputHTML = '';

                if (type === 'daily') {
                    const selectedDate = document.getElementById('report-date').value;
                    const dailySales = receipts.filter(r => r.date === selectedDate);
                    const totalDailySales = dailySales.reduce((sum, r) => sum + r.totalPrice, 0);
                    outputHTML = `<h3>Daily Sales Report for ${selectedDate}</h3>`;
                    outputHTML += `<p>Total Sales: ${totalDailySales.toFixed(2)}</p>`;
                    outputHTML += '<table><thead><tr><th>Customer</th><th>Item</th><th>Price</th><th>Status</th></tr></thead><tbody>';
                    dailySales.forEach(r => {
                         outputHTML += `<tr><td>${r.customerName}</td><td>${r.itemModel}</td><td>${r.totalPrice.toFixed(2)}</td><td>${r.status}</td></tr>`;
                    });
                    outputHTML += '</tbody></table>';

                } else if (type === 'monthly') {
                    const selectedMonth = document.getElementById('report-month').value; // YYYY-MM
                    const monthlySales = receipts.filter(r => r.date.startsWith(selectedMonth));
                     const totalMonthlySales = monthlySales.reduce((sum, r) => sum + r.totalPrice, 0);
                    outputHTML = `<h3>Monthly Sales Report for ${selectedMonth}</h3>`;
                     outputHTML += `<p>Total Sales: ${totalMonthlySales.toFixed(2)}</p>`;
                     outputHTML += '<table><thead><tr><th>Date</th><th>Customer</th><th>Item</th><th>Price</th><th>Status</th></tr></thead><tbody>';
                    monthlySales.forEach(r => {
                         outputHTML += `<tr><td>${r.date}</td><td>${r.customerName}</td><td>${r.itemModel}</td><td>${r.totalPrice.toFixed(2)}</td><td>${r.status}</td></tr>`;
                    });
                     outputHTML += '</tbody></table>';

                } else if (type === 'total-paid') {
                    const paidReceipts = receipts.filter(r => r.status === 'Paid');
                    const totalPaid = paidReceipts.reduce((sum, r) => sum + r.totalPrice, 0);
                    outputHTML = `<h3>Total Paid Amount</h3>`;
                    outputHTML += `<p>Total Paid: ${totalPaid.toFixed(2)}</p>`;
                     outputHTML += '<table><thead><tr><th>Date</th><th>Customer</th><th>Item</th><th>Price</th></tr></thead><tbody>';
                    paidReceipts.forEach(r => {
                         outputHTML += `<tr><td>${r.date}</td><td>${r.customerName}</td><td>${r.itemModel}</td><td>${r.totalPrice.toFixed(2)}</td></tr>`;
                    });
                     outputHTML += '</tbody></table>';

                } else if (type === 'total-udhar') {
                    const udharReceipts = receipts.filter(r => r.status === 'Udhar');
                    const totalUdhar = udharReceipts.reduce((sum, r) => sum + r.totalPrice, 0);
                    outputHTML = `<h3>Total Udhar Amount</h3>`;
                    outputHTML += `<p>Total Udhar: ${totalUdhar.toFixed(2)}</p>`;
                     outputHTML += '<table><thead><tr><th>Date</th><th>Customer</th><th>Item</th><th>Price</th></tr></thead><tbody>';
                    udharReceipts.forEach(r => {
                         outputHTML += `<tr><td>${r.date}</td><td>${r.customerName}</td><td>${r.itemModel}</td><td>${r.totalPrice.toFixed(2)}</td></tr>`;
                    });
                     outputHTML += '</tbody></table>';
                }

                reportOutput.innerHTML = outputHTML;
            };

            request.onerror = function(event) {
                console.error('Error generating report:', event.target.error);
                reportOutput.innerHTML = '<p>Error generating report.</p>';
            };
        }


        // --- Reminders Tab ---
        const remindersTableBody = document.getElementById('reminders-table-body');

        function loadReminders() {
             const transaction = db.transaction(['receipts'], 'readonly');
             const store = transaction.objectStore('receipts');
             const statusIndex = store.index('status');
             const request = statusIndex.openCursor(IDBKeyRange.only('Udhar'));

             remindersTableBody.innerHTML = ''; // Clear previous list

             const udharCustomers = {}; // To aggregate udhar per customer

             request.onsuccess = function(event) {
                 const cursor = event.target.result;
                 if (cursor) {
                     const receipt = cursor.value;
                     if (!udharCustomers[receipt.customerName]) {
                         udharCustomers[receipt.customerName] = {
                             mobile: receipt.customerMobile,
                             totalUdhar: 0
                         };
                     }
                     udharCustomers[receipt.customerName].totalUdhar += receipt.totalPrice;
                     cursor.continue();
                 } else {
                     // Display aggregated udhar customers
                     for (const name in udharCustomers) {
                         const customer = udharCustomers[name];
                         const row = remindersTableBody.insertRow();
                         row.insertCell(0).textContent = name;
                         row.insertCell(1).textContent = customer.mobile || 'N/A';
                         row.insertCell(2).textContent = customer.totalUdhar.toFixed(2);

                         const actionsCell = row.insertCell(3);
                         actionsCell.classList.add('actions');

                         // Basic reminder actions (requires manual sending)
                         if (customer.mobile) {
                             const smsButton = document.createElement('button');
                             smsButton.textContent = 'SMS';
                             smsButton.classList.add('send-reminder');
                             smsButton.onclick = () => sendSMS(customer.mobile, name, customer.totalUdhar);
                             actionsCell.appendChild(smsButton);

                             const whatsappButton = document.createElement('button');
                             whatsappButton.textContent = 'WhatsApp';
                             whatsappButton.classList.add('send-reminder');
                             whatsappButton.onclick = () => sendWhatsApp(customer.mobile, name, customer.totalUdhar);
                             actionsCell.appendChild(whatsappButton);
                         } else {
                             actionsCell.textContent = 'No mobile number';
                         }
                     }
                 }
             };

             request.onerror = function(event) {
                 console.error('Error loading reminders:', event.target.error);
             };
        }

        function sendSMS(mobile, customerName, totalUdhar) {
             const message = `Dear ${customerName}, this is a reminder regarding your outstanding amount of ${totalUdhar.toFixed(2)}. Please contact us for payment arrangements.`;
             window.location.href = `sms:${mobile}?body=${encodeURIComponent(message)}`;
        }

        function sendWhatsApp(mobile, customerName, totalUdhar) {
             const message = `Dear ${customerName}, this is a reminder regarding your outstanding amount of ${totalUdhar.toFixed(2)}. Please contact us for payment arrangements.`;
             // WhatsApp link format: https://wa.me/whatsappphonenumber/?text=urlencodedtext
             // Note: Phone number should be in international format without +, 00 or -
             const formattedMobile = mobile.replace(/[^0-9]/g, ''); // Remove non-digits
             // Assuming Pakistani numbers start with 03, convert to 923
             let internationalMobile = formattedMobile;
             if (internationalMobile.startsWith('03')) {
                 internationalMobile = '92' + internationalMobile.substring(1);
             } else if (!internationalMobile.startsWith('92')) {
                 // Attempt to add 92 if it doesn't seem to be in international format
                  internationalMobile = '92' + internationalMobile;
             }


             window.open(`https://wa.me/${internationalMobile}/?text=${encodeURIComponent(message)}`, '_blank');
        }


        // --- Admin Settings Tab ---
        const adminSettingsForm = document.getElementById('admin-settings-form');

        adminSettingsForm.addEventListener('submit', function(event) {
            event.preventDefault();
            saveSettings();
        });

        function saveSettings() {
            const businessName = document.getElementById('business-name').value;
            const businessContact = document.getElementById('business-contact').value;
            const businessEmail = document.getElementById('business-email').value;
            const businessAddress = document.getElementById('business-address').value;
            const businessLogo = document.getElementById('business-logo').value;

            const settings = [
                { key: 'business-name', value: businessName },
                { key: 'business-contact', value: businessContact },
                { key: 'business-email', value: businessEmail },
                { key: 'business-address', value: businessAddress },
                { key: 'business-logo', value: businessLogo }
            ];

            const transaction = db.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');

            settings.forEach(setting => {
                store.put(setting);
            });

            transaction.oncomplete = function() {
                console.log('Settings saved successfully');
                alert('Settings saved!');
            };

            transaction.onerror = function(event) {
                console.error('Error saving settings:', event.target.error);
                alert('Error saving settings. Please try again.');
            };
        }

        function loadSettings() {
            const transaction = db.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.getAll();

            request.onsuccess = function(event) {
                const settings = event.target.result;
                settings.forEach(setting => {
                    if (document.getElementById(setting.key)) {
                        document.getElementById(setting.key).value = setting.value;
                    }
                });
            };

            request.onerror = function(event) {
                console.error('Error loading settings:', event.target.error);
            };
        }

         function getSettings() {
             return new Promise((resolve, reject) => {
                 const transaction = db.transaction(['settings'], 'readonly');
                 const store = transaction.objectStore('settings');
                 const request = store.getAll();

                 request.onsuccess = function(event) {
                     const settings = {};
                     event.target.result.forEach(setting => {
                         settings[setting.key] = setting.value;
                     });
                     resolve(settings);
                 };

                 request.onerror = function(event) {
                     console.error('Error getting settings:', event.target.error);
                     reject(event.target.error);
                 };
             });
         }


        // --- Backup and Restore ---
        function exportData() {
             const transaction = db.transaction(['receipts', 'settings'], 'readonly');
             const receiptStore = transaction.objectStore('receipts');
             const settingsStore = transaction.objectStore('settings');

             const receiptRequest = receiptStore.getAll();
             const settingsRequest = settingsStore.getAll();

             let receiptsData = [];
             let settingsData = [];

             receiptRequest.onsuccess = function(event) {
                 receiptsData = event.target.result;
             };

             settingsRequest.onsuccess = function(event) {
                 settingsData = event.target.result;
             };

             transaction.oncomplete = function() {
                 const data = {
                     receipts: receiptsData,
                     settings: settingsData
                 };
                 const jsonData = JSON.stringify(data, null, 2);
                 const blob = new Blob([jsonData], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = 'receipt_data_backup.json';
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
             };

             transaction.onerror = function(event) {
                 console.error('Error exporting data:', event.target.error);
                 alert('Error exporting data. Please try again.');
             };
         }

         function importData(event) {
             const file = event.target.files[0];
             if (!file) {
                 return;
             }

             const reader = new FileReader();
             reader.onload = function(e) {
                 try {
                     const data = JSON.parse(e.target.result);
                     if (data.receipts && Array.isArray(data.receipts) && data.settings && Array.isArray(data.settings)) {
                         if (confirm('Importing data will replace existing data. Are you sure?')) {
                             clearAllData().then(() => {
                                 const transaction = db.transaction(['receipts', 'settings'], 'readwrite');
                                 const receiptStore = transaction.objectStore('receipts');
                                 const settingsStore = transaction.objectStore('settings');

                                 data.receipts.forEach(receipt => {
                                     // Remove existing ID to let IndexedDB assign a new one on import
                                     delete receipt.id;
                                     receiptStore.add(receipt);
                                 });

                                 data.settings.forEach(setting => {
                                     settingsStore.put(setting);
                                 });

                                 transaction.oncomplete = function() {
                                     console.log('Data imported successfully');
                                     alert('Data imported successfully!');
                                     loadReceipts(); // Reload UI
                                     loadSettings();
                                     loadReminders();
                                      populateCustomerNamesForLedger();
                                 };

                                 transaction.onerror = function(event) {
                                     console.error('Error importing data:', event.target.error);
                                     alert('Error importing data. Please check the file format.');
                                 };
                             }).catch(error => {
                                 console.error('Error clearing existing data before import:', error);
                                 alert('Error clearing existing data before import.');
                             });
                         }
                     } else {
                         alert('Invalid JSON file format.');
                     }
                 } catch (e) {
                     console.error('Error parsing JSON:', e);
                     alert('Error parsing JSON file. Please check the file format.');
                 }
             };
             reader.readAsText(file);
         }

         function clearAllData() {
             return new Promise((resolve, reject) => {
                 const transaction = db.transaction(['receipts', 'settings'], 'readwrite');
                 const receiptStore = transaction.objectStore('receipts');
                 const settingsStore = transaction.objectStore('settings');

                 const clearReceiptsRequest = receiptStore.clear();
                 const clearSettingsRequest = settingsStore.clear();

                 transaction.oncomplete = function() {
                     console.log('All data cleared');
                     resolve();
                 };

                 transaction.onerror = function(event) {
                     console.error('Error clearing data:', event.target.error);
                     reject(event.target.error);
                 };
             });
         }


        // Initial load (handled in request.onsuccess)
        // loadSettings();
        // loadReceipts();
        // loadReminders();
        // populateCustomerNamesForLedger();

    </script>
</body>
</html>