<!DOCTYPE html>

<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قسطوں کا ریکارڈ - Installment Khata System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Nastaliq Urdu', Arial, sans-serif; background: #f5f5f5; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .author { font-size: 0.9em; opacity: 0.8; }
        .nav { background: #2c3e50; display: flex; justify-content: center; flex-wrap: wrap; }
        .nav button { background: none; border: none; color: white; padding: 15px 20px; cursor: pointer; transition: background 0.3s; font-family: inherit; }
        .nav button:hover, .nav button.active { background: #34495e; }
        .content { padding: 20px; min-height: 500px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #667eea; outline: none; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; font-family: inherit; }
        .btn:hover { background: #5a67d8; }
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #f56565; }
        .btn-danger:hover { background: #e53e3e; }
        .btn-warning { background: #ed8936; }
        .btn-warning:hover { background: #dd6b20; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .table th, .table td { padding: 12px; text-align: right; border-bottom: 1px solid #e2e8f0; }
        .table th { background: #f7fafc; font-weight: bold; color: #2d3748; }
        .table tr:hover { background: #f7fafc; }
        .search-box { width: 100%; margin-bottom: 20px; padding: 12px; border: 2px solid #667eea; border-radius: 5px; font-size: 16px; font-family: inherit; }
        .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px; }
        .pagination button { padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px; }
        .pagination button.active { background: #667eea; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card h3 { font-size: 2em; margin-bottom: 10px; }
        .stat-card p { font-size: 1.1em; }
        .receipt { background: white; border: 2px solid #333; padding: 20px; margin: 20px 0; font-family: monospace; }
        .receipt-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .receipt-row { display: flex; justify-content: space-between; margin: 5px 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 800px; border-radius: 10px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .hidden { display: none !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .action-buttons { display: flex; gap: 5px; }
        .action-buttons button { padding: 5px 10px; font-size: 12px; }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .nav { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
        }
        @media print {
            body * { visibility: hidden; }
            .receipt, .receipt * { visibility: visible; }
            .receipt { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>قسطوں کا ریکارڈ</h1>
            <p>Pakistani Installment and Khata Management System</p>
            <div class="author">Created by Yasin Ullah - Pakistani Developer</div>
        </div>
        
        <div class="nav">
            <button onclick="showTab('dashboard')" class="tab-btn active">ڈیش بورڈ</button>
            <button onclick="showTab('add-entry')" class="tab-btn">نیا اندراج</button>
            <button onclick="showTab('all-entries')" class="tab-btn">تمام اندراجات</button>
            <button onclick="showTab('khata')" class="tab-btn">کھاتہ</button>
            <button onclick="showTab('reminders')" class="tab-btn">یاددہانیاں</button>
            <button onclick="showTab('reports')" class="tab-btn">رپورٹس</button>
            <button onclick="showTab('settings')" class="tab-btn">ترتیبات</button>
        </div>

        <div class="content">
            <div id="dashboard-tab" class="tab-content active">
                <h2>ڈیش بورڈ</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-customers">0</h3>
                        <p>کل کسٹمرز</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-amount">0</h3>
                        <p>کل رقم</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="pending-amount">0</h3>
                        <p>باقی رقم</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="paid-amount">0</h3>
                        <p>ادا شدہ رقم</p>
                    </div>
                </div>
                <h3>آج کے اندراجات</h3>
                <div id="today-entries"></div>
            </div>

            <div id="add-entry-tab" class="tab-content">
                <h2>نیا اندراج شامل کریں</h2>
                <form id="entry-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>تاریخ</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>کسٹمر کا نام</label>
                            <input type="text" id="customer-name" required>
                        </div>
                        <div class="form-group">
                            <label>موبائل نمبر</label>
                            <input type="tel" id="mobile">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>آئٹم/ماڈل</label>
                            <input type="text" id="item" required>
                        </div>
                        <div class="form-group">
                            <label>مقدار</label>
                            <input type="number" id="quantity" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>کل قیمت</label>
                            <input type="number" id="total-price" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>قسطوں کے مہینے</label>
                            <input type="number" id="installments" min="1" max="60">
                        </div>
                        <div class="form-group">
                            <label>حالت</label>
                            <select id="status">
                                <option value="udhar">ادھار</option>
                                <option value="paid">ادا شدہ</option>
                                <option value="partial">جزوی ادائیگی</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>منظوری</label>
                            <select id="approval">
                                <option value="pending">زیر غور</option>
                                <option value="approved">منظور شدہ</option>
                                <option value="rejected">مسترد</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>نوٹس</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">اندراج محفوظ کریں</button>
                    <button type="button" class="btn" onclick="resetForm()">فارم صاف کریں</button>
                </form>
            </div>

            <div id="all-entries-tab" class="tab-content">
                <h2>تمام اندراجات</h2>
                <input type="text" class="search-box" id="search-entries" placeholder="تلاش کریں...">
                <div style="margin-bottom: 20px;">
                    <select id="filter-status" onchange="filterEntries()">
                        <option value="">تمام حالات</option>
                        <option value="paid">ادا شدہ</option>
                        <option value="udhar">ادھار</option>
                        <option value="partial">جزوی</option>
                    </select>
                    <button class="btn" onclick="exportData()">ڈیٹا ایکسپورٹ</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData()">
                    <button class="btn" onclick="document.getElementById('import-file').click()">ڈیٹا امپورٹ</button>
                </div>
                <div id="entries-table"></div>
                <div class="pagination" id="entries-pagination"></div>
            </div>

            <div id="khata-tab" class="tab-content">
                <h2>کسٹمر کھاتہ</h2>
                <select id="customer-select" onchange="showCustomerKhata()">
                    <option value="">کسٹمر منتخب کریں</option>
                </select>
                <div id="customer-khata"></div>
            </div>

            <div id="reminders-tab" class="tab-content">
                <h2>یاددہانیاں</h2>
                <div id="reminders-list"></div>
                <div style="margin-top: 20px;">
                    <h3>نئی یاددہانی شامل کریں</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>کسٹمر</label>
                            <select id="reminder-customer"></select>
                        </div>
                        <div class="form-group">
                            <label>پیغام</label>
                            <textarea id="reminder-message" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>تاریخ</label>
                            <input type="date" id="reminder-date">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addReminder()">یاددہانی شامل کریں</button>
                </div>
            </div>

            <div id="reports-tab" class="tab-content">
                <h2>رپورٹس</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>شروعاتی تاریخ</label>
                        <input type="date" id="report-start">
                    </div>
                    <div class="form-group">
                        <label>اختتامی تاریخ</label>
                        <input type="date" id="report-end">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="generateReport()">رپورٹ بنائیں</button>
                    </div>
                </div>
                <div id="report-content"></div>
            </div>

            <div id="settings-tab" class="tab-content">
                <h2>ترتیبات</h2>
                <div class="form-group">
                    <label>دکان کا نام</label>
                    <input type="text" id="shop-name" value="قسطوں کی دوکان">
                </div>
                <div class="form-group">
                    <label>پتہ</label>
                    <textarea id="shop-address" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>فون نمبر</label>
                    <input type="tel" id="shop-phone">
                </div>
                <button class="btn btn-success" onclick="saveSettings()">ترتیبات محفوظ کریں</button>
                <button class="btn btn-danger" onclick="clearAllData()">تمام ڈیٹا صاف کریں</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let db;
        let entries = [];
        let currentPage = 1;
        const pageSize = 10;
        let filteredEntries = [];

        const dbInit1 = () => {
            const req1 = indexedDB.open('KhataDB', 1);
            req1.onerror = () => console.error('DB Error');
            req1.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('entries')) {
                    const store1 = db.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
                    store1.createIndex('customer', 'customer', { unique: false });
                    store1.createIndex('date', 'date', { unique: false });
                }
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
                if (!db.objectStoreNames.contains('reminders')) {
                    const store2 = db.createObjectStore('reminders', { keyPath: 'id', autoIncrement: true });
                }
            };
            req1.onsuccess = (e) => {
                db = e.target.result;
                loadEntries();
                loadSettings();
                updateDashboard();
            };
        };

        const addEntry1 = async (entry) => {
            const tx1 = db.transaction(['entries'], 'readwrite');
            const store1 = tx1.objectStore('entries');
            await store1.add(entry);
            loadEntries();
            updateDashboard();
        };

        const loadEntries = () => {
            const tx1 = db.transaction(['entries'], 'readonly');
            const store1 = tx1.objectStore('entries');
            const req1 = store1.getAll();
            req1.onsuccess = () => {
                entries = req1.result;
                filteredEntries = [...entries];
                displayEntries();
                updateCustomerSelects();
            };
        };

        const deleteEntry1 = async (id) => {
            if (confirm('کیا آپ واقعی اس اندراج کو حذف کرنا چاہتے ہیں؟')) {
                const tx1 = db.transaction(['entries'], 'readwrite');
                const store1 = tx1.objectStore('entries');
                await store1.delete(id);
                loadEntries();
                updateDashboard();
            }
        };

        const editEntry1 = (id) => {
            const entry = entries.find(e => e.id === id);
            if (entry) {
                document.getElementById('date').value = entry.date;
                document.getElementById('customer-name').value = entry.customer;
                document.getElementById('mobile').value = entry.mobile || '';
                document.getElementById('item').value = entry.item;
                document.getElementById('quantity').value = entry.quantity;
                document.getElementById('total-price').value = entry.totalPrice;
                document.getElementById('installments').value = entry.installments || '';
                document.getElementById('status').value = entry.status;
                document.getElementById('approval').value = entry.approval || 'pending';
                document.getElementById('notes').value = entry.notes || '';
                
                const form1 = document.getElementById('entry-form');
                form1.onsubmit = async (e) => {
                    e.preventDefault();
                    const updatedEntry = {
                        id: id,
                        date: document.getElementById('date').value,
                        customer: document.getElementById('customer-name').value,
                        mobile: document.getElementById('mobile').value,
                        item: document.getElementById('item').value,
                        quantity: parseInt(document.getElementById('quantity').value),
                        totalPrice: parseFloat(document.getElementById('total-price').value),
                        installments: parseInt(document.getElementById('installments').value) || null,
                        status: document.getElementById('status').value,
                        approval: document.getElementById('approval').value,
                        notes: document.getElementById('notes').value,
                        createdAt: entry.createdAt,
                        updatedAt: new Date().toISOString()
                    };
                    
                    const tx1 = db.transaction(['entries'], 'readwrite');
                    const store1 = tx1.objectStore('entries');
                    await store1.put(updatedEntry);
                    
                    form1.onsubmit = handleFormSubmit;
                    form1.reset();
                    loadEntries();
                    updateDashboard();
                    showTab('all-entries');
                    alert('اندراج اپ ڈیٹ ہو گیا');
                };
                showTab('add-entry');
            }
        };

        const displayEntries = () => {
            const start1 = (currentPage - 1) * pageSize;
            const end1 = start1 + pageSize;
            const pageEntries = filteredEntries.slice(start1, end1);
            
            const table1 = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>تاریخ</th>
                            <th>کسٹمر</th>
                            <th>آئٹم</th>
                            <th>قیمت</th>
                            <th>حالت</th>
                            <th>عمل</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageEntries.map(entry => `
                            <tr>
                                <td>${new Date(entry.date).toLocaleDateString('ur-PK')}</td>
                                <td>${entry.customer}</td>
                                <td>${entry.item}</td>
                                <td>${entry.totalPrice}</td>
                                <td>${getStatusText(entry.status)}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-warning" onclick="editEntry1(${entry.id})">ترمیم</button>
                                    <button class="btn btn-danger" onclick="deleteEntry1(${entry.id})">حذف</button>
                                    <button class="btn" onclick="printReceipt(${entry.id})">پرنٹ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('entries-table').innerHTML = table1;
            displayPagination();
        };

        const displayPagination = () => {
            const totalPages = Math.ceil(filteredEntries.length / pageSize);
            let pagination1 = '';
            
            if (currentPage > 1) {
                pagination1 += `<button onclick="changePage(${currentPage - 1})">پچھلا</button>`;
            }
            
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                pagination1 += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            
            if (currentPage < totalPages) {
                pagination1 += `<button onclick="changePage(${currentPage + 1})">اگلا</button>`;
            }
            
            document.getElementById('entries-pagination').innerHTML = pagination1;
        };

        const changePage = (page) => {
            currentPage = page;
            displayEntries();
        };

        const getStatusText = (status) => {
            const statusMap = {
                'paid': 'ادا شدہ',
                'udhar': 'ادھار',
                'partial': 'جزوی'
            };
            return statusMap[status] || status;
        };

        const showTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event?.target?.classList.add('active');
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const entry = {
                date: document.getElementById('date').value,
                customer: document.getElementById('customer-name').value,
                mobile: document.getElementById('mobile').value,
                item: document.getElementById('item').value,
                quantity: parseInt(document.getElementById('quantity').value),
                totalPrice: parseFloat(document.getElementById('total-price').value),
                installments: parseInt(document.getElementById('installments').value) || null,
                status: document.getElementById('status').value,
                approval: document.getElementById('approval').value,
                notes: document.getElementById('notes').value,
                createdAt: new Date().toISOString()
            };
            
            await addEntry1(entry);
            document.getElementById('entry-form').reset();
            alert('اندراج محفوظ ہو گیا');
        };

        const resetForm = () => {
            document.getElementById('entry-form').reset();
            document.getElementById('date').value = new Date().toISOString().split('T');
        };

        const filterEntries = () => {
            const searchTerm = document.getElementById('search-entries').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            
            filteredEntries = entries.filter(entry => {
                const matchesSearch = Object.values(entry).some(val => 
                    val && val.toString().toLowerCase().includes(searchTerm)
                );
                const matchesStatus = !statusFilter || entry.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            currentPage = 1;
            displayEntries();
        };

        const updateDashboard = () => {
            const customers1 = [...new Set(entries.map(e => e.customer))];
            const totalAmount1 = entries.reduce((sum, e) => sum + (e.totalPrice || 0), 0);
            const paidAmount1 = entries.filter(e => e.status === 'paid').reduce((sum, e) => sum + (e.totalPrice || 0), 0);
            const pendingAmount1 = totalAmount1 - paidAmount1;
            
            document.getElementById('total-customers').textContent = customers1.length;
            document.getElementById('total-amount').textContent = totalAmount1.toLocaleString();
            document.getElementById('pending-amount').textContent = pendingAmount1.toLocaleString();
            document.getElementById('paid-amount').textContent = paidAmount1.toLocaleString();
            
            const today1 = new Date().toISOString().split('T');
            const todayEntries = entries.filter(e => e.date === today1);
            document.getElementById('today-entries').innerHTML = `
                <p>آج ${todayEntries.length} نئے اندراجات</p>
                ${todayEntries.slice(0, 5).map(e => `<p>-  ${e.customer} - ${e.item} - ${e.totalPrice}</p>`).join('')}
            `;
        };

        const updateCustomerSelects = () => {
            const customers1 = [...new Set(entries.map(e => e.customer))];
            const selects1 = ['customer-select', 'reminder-customer'];
            
            selects1.forEach(selectId => {
                const select1 = document.getElementById(selectId);
                select1.innerHTML = '<option value="">کسٹمر منتخب کریں</option>';
                customers1.forEach(customer => {
                    select1.innerHTML += `<option value="${customer}">${customer}</option>`;
                });
            });
        };

        const showCustomerKhata = () => {
            const customer1 = document.getElementById('customer-select').value;
            if (!customer1) return;
            
            const customerEntries = entries.filter(e => e.customer === customer1);
            const totalAmount1 = customerEntries.reduce((sum, e) => sum + (e.totalPrice || 0), 0);
            const paidAmount1 = customerEntries.filter(e => e.status === 'paid').reduce((sum, e) => sum + (e.totalPrice || 0), 0);
            const pendingAmount1 = totalAmount1 - paidAmount1;
            
            const khataHtml = `
                <div style="margin: 20px 0; padding: 20px; border: 2px solid #333; background: #f9f9f9;">
                    <h3>${customer1} کا کھاتہ</h3>
                    <p><strong>کل رقم:</strong> ${totalAmount1.toLocaleString()}</p>
                    <p><strong>ادا شدہ:</strong> ${paidAmount1.toLocaleString()}</p>
                    <p><strong>باقی:</strong> ${pendingAmount1.toLocaleString()}</p>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>تاریخ</th>
                                <th>آئٹم</th>
                                <th>رقم</th>
                                <th>حالت</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customerEntries.map(entry => `
                                <tr>
                                    <td>${new Date(entry.date).toLocaleDateString('ur-PK')}</td>
                                    <td>${entry.item}</td>
                                    <td>${entry.totalPrice}</td>
                                    <td>${getStatusText(entry.status)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <button class="btn" onclick="sendWhatsAppReminder('${customer1}', ${pendingAmount1})">WhatsApp یاددہانی</button>
                    <button class="btn" onclick="printCustomerKhata('${customer1}')">کھاتہ پرنٹ کریں</button>
                </div>
            `;
            
            document.getElementById('customer-khata').innerHTML = khataHtml;
        };

        const printReceipt = (id) => {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            
            const settings1 = getSettings();
            const receiptHtml = `
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>${settings1.shopName || 'قسطوں کی دوکان'}</h2>
                        <p>${settings1.shopAddress || ''}</p>
                        <p>${settings1.shopPhone || ''}</p>
                        <p>رسید نمبر: ${entry.id}</p>
                    </div>
                    
                    <div class="receipt-row">
                        <span>تاریخ:</span>
                        <span>${new Date(entry.date).toLocaleDateString('ur-PK')}</span>
                    </div>
                    
                    <div class="receipt-row">
                        <span>کسٹمر:</span>
                        <span>${entry.customer}</span>
                    </div>
                    
                    <div class="receipt-row">
                        <span>موبائل:</span>
                        <span>${entry.mobile || 'N/A'}</span>
                    </div>
                    
                    <div class="receipt-row">
                        <span>آئٹم:</span>
                        <span>${entry.item}</span>
                    </div>
                    
                    <div class="receipt-row">
                        <span>مقدار:</span>
                        <span>${entry.quantity}</span>
                    </div>
                    
                    <div class="receipt-row">
                        <span>کل قیمت:</span>
                        <span>${entry.totalPrice}</span>
                    </div>
                    
                    ${entry.installments ? `
                    <div class="receipt-row">
                        <span>قسطیں:</span>
                        <span>${entry.installments} مہینے</span>
                    </div>
                    ` : ''}
                    
                    <div class="receipt-row">
                        <span>حالت:</span>
                        <span>${getStatusText(entry.status)}</span>
                    </div>
                    
                    ${entry.notes ? `
                    <div class="receipt-row">
                        <span>نوٹس:</span>
                        <span>${entry.notes}</span>
                    </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 20px; border-top: 1px solid #333; padding-top: 10px;">
                        <p>شکریہ</p>
                        <small>Created by Yasin Ullah - Pakistani Developer</small>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>رسید</title>
                        <style>
                            body { font-family: Arial, sans-serif; direction: rtl; }
                            .receipt { border: 2px solid #333; padding: 20px; font-family: monospace; }
                            .receipt-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
                            .receipt-row { display: flex; justify-content: space-between; margin: 5px 0; }
                        </style>
                    </head>
                    <body>${receiptHtml}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            printWindow.close();
        };

        const printCustomerKhata = (customer1) => {
            const customerEntries = entries.filter(e => e.customer === customer1);
            const settings1 = getSettings();
            
            const khataHtml = `
                <div style="direction: rtl; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center;">${settings1.shopName || 'دوکان'}</h2>
                    <h3 style="text-align: center;">${customer1} کا کھاتہ</h3>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="border-bottom: 2px solid #333;">
                                <th style="padding: 10px; text-align: right;">تاریخ</th>
                                <th style="padding: 10px; text-align: right;">آئٹم</th>
                                <th style="padding: 10px; text-align: right;">رقم</th>
                                <th style="padding: 10px; text-align: right;">حالت</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customerEntries.map(entry => `
                                <tr style="border-bottom: 1px solid #ccc;">
                                    <td style="padding: 8px;">${new Date(entry.date).toLocaleDateString('ur-PK')}</td>
                                    <td style="padding: 8px;">${entry.item}</td>
                                    <td style="padding: 8px;">${entry.totalPrice}</td>
                                    <td style="padding: 8px;">${getStatusText(entry.status)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(khataHtml);
            printWindow.document.close();
            printWindow.print();
            printWindow.close();
        };

        const addReminder = async () => {
            const customer1 = document.getElementById('reminder-customer').value;
            const message1 = document.getElementById('reminder-message').value;
            const date1 = document.getElementById('reminder-date').value;
            
            if (!customer1 || !message1 || !date1) {
                alert('تمام فیلڈز بھریں');
                return;
            }
            
            const reminder1 = {
                customer: customer1,
                message: message1,
                date: date1,
                createdAt: new Date().toISOString()
            };
            
            const tx1 = db.transaction(['reminders'], 'readwrite');
            const store1 = tx1.objectStore('reminders');
            await store1.add(reminder1);
            
            document.getElementById('reminder-customer').value = '';
            document.getElementById('reminder-message').value = '';
            document.getElementById('reminder-date').value = '';
            
            loadReminders();
            alert('یاددہانی شامل کر دی گئی');
        };

        const loadReminders = () => {
            const tx1 = db.transaction(['reminders'], 'readonly');
            const store1 = tx1.objectStore('reminders');
            const req1 = store1.getAll();
            
            req1.onsuccess = () => {
                const reminders1 = req1.result;
                const remindersList = document.getElementById('reminders-list');
                
                remindersList.innerHTML = reminders1.map(reminder => `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                        <h4>${reminder.customer}</h4>
                        <p>${reminder.message}</p>
                        <p><strong>تاریخ:</strong> ${new Date(reminder.date).toLocaleDateString('ur-PK')}</p>
                        <button class="btn btn-danger" onclick="deleteReminder(${reminder.id})">حذف</button>
                    </div>
                `).join('');
            };
        };

        const deleteReminder = async (id) => {
            const tx1 = db.transaction(['reminders'], 'readwrite');
            const store1 = tx1.objectStore('reminders');
            await store1.delete(id);
            loadReminders();
        };

        const sendWhatsAppReminder = (customer1, amount1) => {
            const message1 = `السلام علیکم ${customer1} صاحب، آپ کی ${amount1} روپے کی رقم باقی ہے۔ براہ کرم جلد ادائیگی کریں۔ شکریہ`;
            const url1 = `https://wa.me/?text=${encodeURIComponent(message1)}`;
            window.open(url1, '_blank');
        };

        const generateReport = () => {
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;
            
            if (!startDate || !endDate) {
                alert('تاریخ کی رینج منتخب کریں');
                return;
            }
            
            const reportEntries = entries.filter(e => e.date >= startDate && e.date <= endDate);
            const totalAmount1 = reportEntries.reduce((sum, e) => sum + (e.totalPrice || 0), 0);
            const paidAmount1 = reportEntries.filter(e => e.status === 'paid').reduce((sum, e) => sum + (e.totalPrice || 0), 0);
            const pendingAmount1 = totalAmount1 - paidAmount1;
            
            const reportHtml = `
                <h3>${startDate} سے ${endDate} تک کی رپورٹ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${reportEntries.length}</h3>
                        <p>کل اندراجات</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalAmount1.toLocaleString()}</h3>
                        <p>کل رقم</p>
                    </div>
                    <div class="stat-card">
                        <h3>${paidAmount1.toLocaleString()}</h3>
                        <p>ادا شدہ رقم</p>
                    </div>
                    <div class="stat-card">
                        <h3>${pendingAmount1.toLocaleString()}</h3>
                        <p>باقی رقم</p>
                    </div>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>تاریخ</th>
                            <th>کسٹمر</th>
                            <th>آئٹم</th>
                            <th>رقم</th>
                            <th>حالت</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reportEntries.map(entry => `
                            <tr>
                                <td>${new Date(entry.date).toLocaleDateString('ur-PK')}</td>
                                <td>${entry.customer}</td>
                                <td>${entry.item}</td>
                                <td>${entry.totalPrice}</td>
                                <td>${getStatusText(entry.status)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <button class="btn" onclick="printReport()">رپورٹ پرنٹ کریں</button>
            `;
            
            document.getElementById('report-content').innerHTML = reportHtml;
        };

        const exportData = () => {
            const data1 = {
                entries: entries,
                settings: getSettings(),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob1 = new Blob([JSON.stringify(data1, null, 2)], { type: 'application/json' });
            const url1 = URL.createObjectURL(blob1);
            const a1 = document.createElement('a');
            a1.href = url1;
            a1.download = `khata-backup-${new Date().toISOString().split('T')}.json`;
            document.body.appendChild(a1);
            a1.click();
            document.body.removeChild(a1);
            URL.revokeObjectURL(url1);
        };

        const importData = () => {
            const file1 = document.getElementById('import-file').files;
            if (!file1) return;
            
            const reader1 = new FileReader();
            reader1.onload = async (e) => {
                try {
                    const data1 = JSON.parse(e.target.result);
                    
                    if (data1.entries && Array.isArray(data1.entries)) {
                        const tx1 = db.transaction(['entries'], 'readwrite');
                        const store1 = tx1.objectStore('entries');
                        
                        for (const entry of data1.entries) {
                            delete entry.id;
                            await store1.add(entry);
                        }
                        
                        loadEntries();
                        updateDashboard();
                        alert('ڈیٹا امپورٹ ہو گیا');
                    }
                } catch (error) {
                    alert('فائل میں خرابی ہے');
                }
            };
            reader1.readAsText(file1);
        };

        const saveSettings = async () => {
            const settings1 = {
                shopName: document.getElementById('shop-name').value,
                shopAddress: document.getElementById('shop-address').value,
                shopPhone: document.getElementById('shop-phone').value
            };
            
            const tx1 = db.transaction(['settings'], 'readwrite');
            const store1 = tx1.objectStore('settings');
            
            for (const [key, value] of Object.entries(settings1)) {
                await store1.put({ key, value });
            }
            
            alert('ترتیبات محفوظ ہو گئیں');
        };

        const loadSettings = () => {
            const tx1 = db.transaction(['settings'], 'readonly');
            const store1 = tx1.objectStore('settings');
            
            store1.getAll().onsuccess = (e) => {
                const settings1 = {};
                e.target.result.forEach(item => {
                    settings1[item.key] = item.value;
                });
                
                document.getElementById('shop-name').value = settings1.shopName || '';
                document.getElementById('shop-address').value = settings1.shopAddress || '';
                document.getElementById('shop-phone').value = settings1.shopPhone || '';
            };
        };

        const getSettings = () => {
            return {
                shopName: document.getElementById('shop-name').value,
                shopAddress: document.getElementById('shop-address').value,
                shopPhone: document.getElementById('shop-phone').value
            };
        };

        const clearAllData = () => {
            if (confirm('کیا آپ واقعی تمام ڈیٹا صاف کرنا چاہتے ہیں؟ یہ عمل واپس نہیں ہو سکتا۔')) {
                const tx1 = db.transaction(['entries', 'reminders'], 'readwrite');
                tx1.objectStore('entries').clear();
                tx1.objectStore('reminders').clear();
                
                entries = [];
                filteredEntries = [];
                loadEntries();
                loadReminders();
                updateDashboard();
                alert('تمام ڈیٹا صاف ہو گیا');
            }
        };

        const closeModal = () => {
            document.getElementById('modal').style.display = 'none';
        };

        document.getElementById('entry-form').addEventListener('submit', handleFormSubmit);
        document.getElementById('search-entries').addEventListener('input', filterEntries);
        
        document.getElementById('date').value = new Date().toISOString().split('T');
        document.getElementById('report-start').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T');
        document.getElementById('report-end').value = new Date().toISOString().split('T');

        window.onclick = (event) => {
            const modal1 = document.getElementById('modal');
            if (event.target === modal1) {
                modal1.style.display = 'none';
            }
        };

        dbInit1();
        
        setTimeout(() => {
            loadReminders();
        }, 1000);
    </script>
</body>
</html>
